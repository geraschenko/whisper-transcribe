#!/bin/bash

# Toggle script for whisper-transcribe
# Sends SIGUSR1 to running transcription app

set -euo pipefail

CONFIG_DIR="$HOME/.config/whisper-transcribe"
PID_FILE="$CONFIG_DIR/app.pid"

# Check if PID file exists
if [ ! -f "$PID_FILE" ]; then
    echo "Error: Whisper transcribe app not running (no PID file found)"
    echo "Start it with: whisper-transcribe.py"
    exit 1
fi

# Read PID
PID=$(cat "$PID_FILE")

# Check if PID is valid number
if ! [[ "$PID" =~ ^[0-9]+$ ]]; then
    echo "Error: Invalid PID in file: $PID"
    exit 1
fi

# Check if process is actually running
if ! kill -0 "$PID" 2>/dev/null; then
    echo "Error: Process $PID not running (stale PID file)"
    echo "Removing stale PID file"
    rm -f "$PID_FILE"
    exit 1
fi

# Send toggle signal
echo "Sending toggle signal to whisper-transcribe (PID: $PID)"
kill -USR1 "$PID"

echo "Toggle signal sent successfully"